<?phpinclude_once "db.php";class silverpopsendmailtoken extends db{	function __construct(){				}	function runservice(){		global $CONFIG;		$userdata = false;		$sql = "			SELECT * FROM `marlboro.ph2`.social_member WHERE DATE(register_date) >= '2013-05-27' AND DATE(register_date) <= '2013-05-31' AND verified = 0					";					// DATE(register_date) >= '2013-05-27' AND DATE(register_date) <= '2013-05-31' AND verified = 0		$list = $this->fetch($sql,true);					if ($list){			foreach($list as $res){				// kirim akun login				// $m[] = $res->email;				$to = $res->email;				$from = $CONFIG['EMAIL_FROM_DEFAULT'];				$subject = "Data login";				$emailtoken = $this->substringshash(sha1('email_token_validasi'.date('Y-m-d H:i:s').$to),10);				// $t[] = $this->substringshash(sha1('email_token_validasi'.date('Y-m-d H:i:s').$to),10);																								$userdata['email'] = $to;						$userdata['firstname'] = $res->name;						$userdata['lastname'] = $res->last_name;						$userdata['username'] = $to;						$userdata['password'] = $res->password;						// $userdata['url'] = $msg;						$userdata['trackingcode'] = $emailtoken;													if($userdata){													$this->getEmailTemplate('trackingcode',$userdata,'send');						 $data[] = true;						 						$sql = "UPDATE social_member SET email_token = '{$emailtoken}' WHERE email = '{$to}' LIMIT 1";															$qData = $this->query($sql);										}else $data[] = false;				$udata[] = $userdata;								sleep(3);						}		}			print "<pre>";			// print_r($t);			print_r($udata);								print "</pre>";		exit;	}		function getEmailTemplate($mailtemplate='welcomeweb',$userdata=false,$sendType='send'){		global $CONFIG;		/* user data is array field */		if($userdata==false) return false;				$host = "api2.silverpop.com";		$adminuser = "inong@marlboro.ph";		$adminpass = "Kana9i8u";		$servlet = "http://api2.silverpop.com/servlet/XMLAPI";		$list_id = false;		$mailid = false;		$email = false;		$firstname = false;		$username = false;		$password = false;		$lastname = false;		$trackingcode = false;		$MAIL = false;		/* sample 						$arrData['email'] = "rizal@kana.co.id";			$arrData['firstname'] = "rizal aja";			$arrData['username'] = "rizal@kana.co.id";			$arrData['password'] = "9234g2934h239h40203240239480298wrjoiwtowehtoerhtiuerhteukrtj";			$arrData['lastname'] = "9234g2934h239h40203240239480298wrjoiwtowehtoerhtiuerhteukrtj";			$arrData['trackingcode'] = "9234g2934h239h40203240239480298wrjoiwtowehtoerhtiuerhteukrtj";				*/		foreach($userdata as $key => $val){			$arrData[$key] = $val;			$$key = $val;		}					include "../../config/mail.inc.php";		if($MAIL){			$arrData['mailid'] =  $MAIL[$mailtemplate]['mailid'];			$arrData['templatedataxml'] = $MAIL[$mailtemplate]['template'];						if($sendType=='send') {				$this->addRecipeForSilverPop($arrData,$adminuser,$adminpass, $host);				sleep(1);				$this->sendMailViaSilverPop($arrData,$adminuser,$adminpass, $host);			}else $this->addRecipeForSilverPop($arrData,$adminuser,$adminpass, $host); 		}	}	function addRecipeForSilverPop($arrData,$adminname,$adminpass,  $host, $servlet="XMLAPI", $port=80, $time_out=20){		$servlet = $servlet;		foreach($arrData as $key => $val){		$$key = $val;	}	$sock = fsockopen ($host, $port, $errno, $errstr, $time_out); // open socket on port 80 w/ timeout of 20	$data = "xml=<?xml version=\"1.0\" encoding=\"UTF-8\" ?><Envelope><Body>";	$data .= "<Login>";	$data .= "<USERNAME>".$adminname."</USERNAME>";	$data .= "<PASSWORD>".$adminpass."</PASSWORD>";	$data .= "</Login>";	$data .= "<AddRecipient>";	$data .= $templatedataxml;	$data .= "</AddRecipient>";	$data .= "</Body></Envelope>";	if (!$sock)	{	print("Could not connect to host:". $errno . $errstr);	return (false);	}	$size = strlen ($data);	fputs ($sock, "POST /servlet/" . $servlet . " HTTP/1.1\n");	fputs ($sock, "Host: " . $host . "\n");	fputs ($sock, "Content-type: application/x-www-form-urlencoded\n");	fputs ($sock, "Content-length: " . $size . "\n");	fputs ($sock, "Connection: close\n\n");	fputs ($sock, $data);	$buffer = "";	while (!feof ($sock)) {	$buffer .= fgets ($sock);	}	// pr($data);	fclose ($sock);	return ($buffer);	}	function sendMailViaSilverPop($arrData,$adminname,$adminpass, $host, $servlet="XMLAPI", $port=80, $time_out=20){	$servlet = $servlet;		foreach($arrData as $key => $val){		$$key = $val;	}	$sock = fsockopen ($host, $port, $errno, $errstr, $time_out); // open socket on port 80 w/ timeout of 20	$data = "xml=<?xml version=\"1.0\" encoding=\"UTF-8\" ?><Envelope><Body>";	$data .= "<Login>";	$data .= "<USERNAME>".$adminname."</USERNAME>";	$data .= "<PASSWORD>".$adminpass."</PASSWORD>";	$data .= "</Login>";	$data .= "<SendMailing>	<MailingId>".$mailid."</MailingId>	<RecipientEmail>".$email."</RecipientEmail>";		$data .= "</SendMailing></Body></Envelope>";	if (!$sock)	{	print("Could not connect to host:". $errno . $errstr);	return (false);	}	$size = strlen ($data);	fputs ($sock, "POST /servlet/" . $servlet . " HTTP/1.1\n");	fputs ($sock, "Host: " . $host . "\n");	fputs ($sock, "Content-type: application/x-www-form-urlencoded\n");	fputs ($sock, "Content-length: " . $size . "\n");	fputs ($sock, "Connection: close\n\n");	fputs ($sock, $data);	$buffer = "";	while (!feof ($sock)) {	$buffer .= fgets ($sock);	}	// pr($data);	fclose ($sock);	return ($buffer);	}			function substringshash($hasher=null,$limit=10){			if($hasher==null) return false;			$strings = substr($hasher,0,$limit);						return $strings;	}	}$class = new silverpopsendmailtoken;$class->runservice(); die();?>